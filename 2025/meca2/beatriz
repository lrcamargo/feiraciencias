//define os pinos da porta como nomes para facilitar a programação

// --- LEDS ---
#define vermelho 5
#define amarelo 4
#define verde 2

// --- SENSOR ULTRASSONICO 01 ---
#define trigger1 14
#define echo1 13

// --- SENSOR ULTRASSONICO 02 ---
#define trigger2 27
#define echo2 26

// --- VARIAVEIS E CONSTANTES ---
float TempoEcho1 = 0;
float TempoEcho2 = 0;
float DistanciaCM1 = 0; 
float DistanciaCM2 = 0; 

// Constantes físicas para cálculo de distância
const float VelocidadeSom_mporus = 0.000340; // em metros por microsegundo

// --- LIMIARES PARA CONTROLE DOS LEDS (EM CENTÍMETROS) ---
// Define as faixas de proximidade. O LED acenderá de acordo com A MENOR distância.
#define LIMIAR_VERDE 80.0    // Distância >= 80 cm (Longe) -> Verde
#define LIMIAR_AMARELO 40.0  // Distância > 40 cm e < 80 cm (Aviso) -> Amarelo
// Distância <= 40 cm (Perigo) -> Vermelho


void setup() {
  // Inicializa a porta serial para depuração
  Serial.begin(115200);

  // --- CONFIGURAÇÃO DOS LEDS (SAÍDA) ---
  pinMode(vermelho, OUTPUT);
  pinMode(amarelo, OUTPUT);
  pinMode(verde, OUTPUT);

  // --- CONFIGURAÇÃO ULTRASSONICO 01 ---
  pinMode(trigger1, OUTPUT);
  digitalWrite(trigger1, LOW);
  pinMode(echo1, INPUT);

  // --- CONFIGURAÇÃO ULTRASSONICO 02 ---
  pinMode(trigger2, OUTPUT);
  digitalWrite(trigger2, LOW);
  pinMode(echo2, INPUT);
}

void loop() {
  // --- LEITURA DO SENSOR 01 ---
  DisparaPulsoUltrassonico(trigger1);
  TempoEcho1 = pulseIn(echo1, HIGH);
  DistanciaCM1 = CalculaDistanciaCM(TempoEcho1);

  // --- LEITURA DO SENSOR 02 ---
  DisparaPulsoUltrassonico(trigger2);
  TempoEcho2 = pulseIn(echo2, HIGH);
  DistanciaCM2 = CalculaDistanciaCM(TempoEcho2);

  // --- CONTROLE DOS LEDS COM BASE NA MENOR DISTÂNCIA ---
  ControlaLEDs(DistanciaCM1, DistanciaCM2);

  // --- IMPRESSÃO DOS RESULTADOS ---
  Serial.println("--- RESULTADOS ---");
  Serial.print("S1 Distancia (cm): ");
  Serial.println(DistanciaCM1);
  Serial.print("S2 Distancia (cm): ");
  Serial.println(DistanciaCM2);

  delay(500); 
}

// -------------------------------------------------------------------
// --- FUNÇÕES AUXILIARES ---
// -------------------------------------------------------------------

// Funçao para enviar o pulso de trigger
void DisparaPulsoUltrassonico(int pinoTrigger){
  digitalWrite(pinoTrigger, HIGH);
  delayMicroseconds(10);
  digitalWrite(pinoTrigger, LOW);
}

// Função para calcular a distancia em centimetros
float CalculaDistanciaCM(float tempo_us){
  // Retorna a distância em centímetros
  return((tempo_us * VelocidadeSom_mporus) / 2) * 100;
}

// Função para acender os LEDs com base na MENOR distância detectada
void ControlaLEDs(float dist1, float dist2){
  // 1. Encontra a menor distância. Ignora leituras de 0 (que geralmente indicam erro/timeout)
  float menorDistancia = dist1;
  
  // Se a Distancia 2 for menor que a Distancia 1, usa a D2
  if (dist2 < menorDistancia && dist2 > 0) {
      menorDistancia = dist2;
  }
  
  // Se a menor distância for 0, saímos para não acender o Vermelho por erro
  if (menorDistancia == 0) {
      return; 
  }
  
  // Desliga todos os LEDs para garantir que apenas um acenda
  digitalWrite(verde, LOW);
  digitalWrite(amarelo, LOW);
  digitalWrite(vermelho, LOW);

  // 2. Acende o LED baseado na faixa da menor distância
  if (menorDistancia <= LIMIAR_AMARELO) {
    // Distância Perto (<= 40 cm) - Prioridade Máxima
    digitalWrite(vermelho, HIGH);
  } else if (menorDistancia < LIMIAR_VERDE) {
    // Distância Média (entre 40 cm e 80 cm)
    digitalWrite(amarelo, HIGH);
  } else { // menorDistancia >= LIMIAR_VERDE
    // Distância Longe (>= 80 cm)
    digitalWrite(verde, HIGH);
  }
}
